<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Mondiale Club - Progetto Avanzato</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background: #aad3df; }
        
        /* Loading Overlay */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background:white;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            z-index: 9999; transition: opacity 0.5s;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Pannello UI */
        #ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 18px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 260px;
            border: 1px solid rgba(255,255,255,0.3); max-height: 90vh; overflow-y: auto;
        }
        
        #search-container { margin-bottom: 15px; display: flex; gap: 5px; }
        #search-input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        .btn-ui {
            background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px;
            padding: 8px; cursor: pointer; font-size: 12px; font-weight: bold;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-reset { background: #fee; color: #c33; border-color: #fcc; }
        .btn-wiki { background: #e7f3ff; color: #007bff; border: 1px solid #b2d7ff; margin-top: 10px; width: 100%; text-decoration: none; display: inline-flex; }

        /* Icone e Cluster */
        .custom-div-icon { background: none; border: none; }
        .logo-container {
            border-radius: 50%; padding: 3px; display: flex; justify-content: center; align-items: center;
            transition: all 0.3s; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            width: 44px; height: 44px;
        }
        .logo-container:hover { transform: scale(1.3); z-index: 1000 !important; }
        .logo-img-inner { width: 100%; height: 100%; border-radius: 50%; background: white; object-fit: contain; }
        .club-scomparso { filter: grayscale(100%); opacity: 0.8; }
        
        /* Popup */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; }
        .popup-card { text-align: center; width: 220px; }
        .popup-title { margin: 5px 0; font-size: 1.1em; text-transform: uppercase; }
        .popup-info { font-size: 13px; color: #555; }
        .centenario-box { background: #fff9c4; padding: 8px; border-radius: 8px; margin-top: 10px; border: 1px solid #fbc02d; }
        .centenario-img { width: 45px; height: 45px; object-fit: contain; }

        .stat-item { font-size: 13px; font-weight: bold; margin: 8px 0; color: #444; display: block; }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        .flag-icon { width: 22px; vertical-align: middle; margin-right: 6px; }

        .custom-ctrl { background: white; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); cursor: pointer; }
        .ctrl-btn { width: 34px; height: 34px; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p>Caricamento Database...</p>
</div>

<div id="ui-panel">
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Cerca (premi '/' per focus)...">
        <button class="btn-ui btn-reset" onclick="resetFiltri()">‚úï</button>
    </div>
    
    <button class="btn-ui" style="width:100%; margin-bottom:10px;" onclick="clubCasuale()">üé≤ Club Casuale</button>
    
    <div id="count-box" class="stat-item">Pronto</div>
    <hr>
    
    <label class="stat-item">Visualizzazione:</label>
    <select id="map-style" onchange="changeMapStyle(this.value)">
        <option value="chiara">Mappa Chiara</option>
        <option value="satellite">Satellite</option>
        <option value="oscura">Dark Mode</option>
        <option value="heatmap">Mappa di Calore (Heatmap)</option>
    </select>
    
    <hr>
    <label class="stat-item">Nazione:</label>
    <select id="filter-nazione"><option value="Tutti">Tutte le nazioni</option></select>
    
    <label class="stat-item">Sport:</label>
    <select id="filter-sport">
        <option value="Tutti">Tutti</option>
        <option value="Calcio">Calcio ‚öΩ</option>
        <option value="Pallacanestro">Pallacanestro üèÄ</option>
        <option value="Pallavolo">Pallavolo üèê</option>
        <option value="Rugby">Rugby üèâ</option>
        <option value="Pallamano">Pallamano ü§æ</option>
        <option value="Pallanuoto">Pallanuoto ü§Ω</option>
        <option value="Hockey su ghiaccio">Hockey su ghiaccio üèí</option>
        <option value="Football americano">Football americano üèà</option>
        <option value="Baseball">Baseball ‚öæ</option>
    </select>

    <label class="stat-item">Stato Club:</label>
    <select id="filter-stato">
        <option value="Tutti">Tutti</option>
        <option value="attivo">Solo Attivi</option>
        <option value="scomparso">Solo Scomparsi</option>
    </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

<script>
    const urlFoglio = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSB3hRuuuzUhGho2Wr_c0KBa8BYYMyASu6n0DrQ8q_o3GU3aw4_oC2vEvhuVbtmqR3Z3y0C5Zgh8Dji/pub?output=csv'; 

    const layers = {
        chiara: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
        oscura: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
    };

    var map = L.map('map', { 
        zoomControl: false, 
        layers: [layers.chiara],
        dragging: !L.Browser.mobile,
        tap: !L.Browser.mobile
    }).setView([45, 10], 5);

    // Gesture handling per mobile
    if (L.Browser.mobile) {
        map.dragging.disable();
        map.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) map.dragging.enable();
        });
        map.addEventListener('touchend', function(e) {
            map.dragging.disable();
        });
    }

    L.control.zoom({ position: 'bottomright' }).addTo(map);
    
    var markers = L.markerClusterGroup({ 
        disableClusteringAtZoom: 17, 
        showCoverageOnHover: false,
        iconCreateFunction: function(cluster) {
            return new L.DivIcon({ 
                html: '<div><span>' + cluster.getChildCount() + '</span></div>', 
                className: 'marker-cluster marker-cluster-small', 
                iconSize: new L.Point(40, 40) 
            });
        }
    });

    var heatLayer = L.heatLayer([], {radius: 25, blur: 15, max: 1.0});
    var oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true, nearbyDistance: 30 });
    var allMarkers = [];
    var visibiliAttualmente = [];
    var popup = L.popup({ className: 'custom-popup', offset: [0, -10] });

    const normalizeText = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";

    function changeMapStyle(style) {
        Object.values(layers).forEach(l => map.removeLayer(l));
        map.removeLayer(markers);
        map.removeLayer(heatLayer);

        if (style === 'heatmap') {
            updateHeatmap();
            heatLayer.addTo(map);
        } else {
            layers[style].addTo(map);
            map.addLayer(markers);
        }
    }

    function updateHeatmap() {
        const points = visibiliAttualmente.map(m => [m.getLatLng().lat, m.getLatLng().lng, 0.5]);
        heatLayer.setLatLngs(points);
    }

    function resetFiltri() {
        document.getElementById('search-input').value = '';
        document.querySelectorAll('select:not(#map-style)').forEach(s => s.value = 'Tutti');
        applicaFiltri();
    }

    function focalizzaClub(marker) {
        map.flyTo(marker.getLatLng(), 16, { animate: true, duration: 1 });
        map.once('moveend', () => {
            popup.setContent(marker.descrizione).setLatLng(marker.getLatLng()).openOn(map);
        });
    }

    function clubCasuale() {
        if (visibiliAttualmente.length === 0) return;
        const randomMarker = visibiliAttualmente[Math.floor(Math.random() * visibiliAttualmente.length)];
        focalizzaClub(randomMarker);
    }

    window.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
    });

    Papa.parse(urlFoglio, {
        download: true,
        header: true,
        complete: function(results) {
            const data = results.data;
            const nazioni = [...new Set(data.map(s => s.nazione))].filter(n => n).sort();
            nazioni.forEach(n => {
                let opt = document.createElement('option');
                opt.value = opt.innerText = n;
                document.getElementById('filter-nazione').appendChild(opt);
            });

            data.forEach(s => {
                if(!s.lat || !s.lng) return;
                let coloriArray = s.colori ? s.colori.split(',') : ['#333'];
                let borderStyle = coloriArray.length > 1 ? `linear-gradient(45deg, ${coloriArray.join(',')})` : coloriArray[0];
                
                var marker = L.marker([parseFloat(s.lat), parseFloat(s.lng)], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="logo-container ${s.stato==='scomparso'?'club-scomparso':''}" style="background: ${borderStyle};">
                                 <img src="${s.logoAttuale}" class="logo-img-inner">
                               </div>`,
                        iconSize: [44, 44], iconAnchor: [22, 22]
                    })
                });

                marker.dati = s;
                marker.nomeNormalizzato = normalizeText(s.nome);
                
                const wikiUrl = `https://it.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(s.nome)}`;

                marker.descrizione = `
                    <div class="popup-card">
                        <div class="popup-header"><h3 class="popup-title">${s.nome}</h3></div>
                        <div class="popup-info">
                            <b>${s.nazione}</b> | Fondazione: ${s.fondazione}<br>
                            Sport: ${s.sport}
                        </div>
                        ${s.logoCentenario ? `<div class="centenario-box"><img src="${s.logoCentenario}" class="centenario-img"></div>` : ''}
                        <a href="${wikiUrl}" target="_blank" class="btn-ui btn-wiki">üìñ Wikipedia</a>
                    </div>`;

                oms.addMarker(marker);
                allMarkers.push(marker);
            });

            window.applicaFiltri = function() {
                const sVal = normalizeText(document.getElementById('search-input').value);
                const nVal = document.getElementById('filter-nazione').value;
                const spVal = document.getElementById('filter-sport').value;
                const stVal = document.getElementById('filter-stato').value;

                markers.clearLayers();
                visibiliAttualmente = allMarkers.filter(m => {
                    if (sVal && !m.nomeNormalizzato.includes(sVal)) return false;
                    if (nVal !== "Tutti" && m.dati.nazione !== nVal) return false;
                    if (spVal !== "Tutti" && m.dati.sport !== spVal) return false;
                    if (stVal !== "Tutti" && m.dati.stato !== stVal) return false;
                    return true;
                });

                visibiliAttualmente.forEach(m => markers.addLayer(m));
                if (document.getElementById('map-style').value === 'heatmap') updateHeatmap();
                
                document.getElementById('count-box').innerHTML = `Club: <b>${visibiliAttualmente.length}</b>`;
                
                // Se c'√® un solo risultato esatto dalla ricerca, focalizza
                if (sVal && visibiliAttualmente.length === 1) {
                    focalizzaClub(visibiliAttualmente[0]);
                }
            }

            document.getElementById('search-input').oninput = applicaFiltri;
            document.querySelectorAll('select:not(#map-style)').forEach(sel => sel.onchange = applicaFiltri);
            
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            applicaFiltri();
        }
    });

    var CustomControls = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'custom-ctrl');
            container.innerHTML = `<div class="ctrl-btn" title="Trovami" onclick="map.locate({setView: true, maxZoom: 13})">üìç</div>`;
            return container;
        }
    });
    map.addControl(new CustomControls());

    markers.on('click', a => {
        popup.setContent(a.layer.descrizione).setLatLng(a.layer.getLatLng()).openOn(map);
    });
</script>
</body>
</html>
