<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Mondiale Club - Progetto Avanzato</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background: #aad3df; }
        
        /* Pannello UI */
        #ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 18px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 260px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .logo-container {
            border-radius: 50%; padding: 3px;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .logo-container:hover { transform: scale(1.4); z-index: 1000 !important; filter: grayscale(0%) !important; opacity: 1 !important; }
        .logo-img-inner { width: 100%; height: 100%; border-radius: 50%; background: white; object-fit: contain; }
        .club-scomparso { filter: grayscale(100%); opacity: 1; }
        
        /* POPUP STYLE */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 2px; }
        .popup-card { text-align: center; width: 210px; padding: 5px; }
        .popup-header { border-bottom: 1px solid #eee; margin-bottom: 8px; padding-bottom: 5px; }
        
        /* Nome squadra pi√π piccolo */
        .popup-title { margin: 2px 0; color: #222; font-size: 1.15em; text-transform: uppercase; font-weight: 800; }
        .popup-info { font-size: 12px; color: #555; line-height: 1.4; }

        /* Box Uniformi per Centenario e Storici */
        .section-label { color: #888; font-weight: bold; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
        
        .centenario-box { margin: 8px 0; padding: 8px; background: #fff9c4; border: 1px solid #fbc02d; border-radius: 8px; }
        .item-img { width: 45px; height: 45px; object-fit: contain; background: white; border-radius: 4px; display: block; margin: 0 auto 3px; }

        /* Griglia Loghi Storici Libera */
        .storico-section { margin-top: 10px; }
        .storico-grid { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; 
            padding: 5px 0; transition: max-height 0.3s ease-out; overflow: hidden;
        }
        .storico-grid.collapsed { max-height: 75px; } /* Altezza per una riga circa */
        
        .storico-item { width: 55px; text-align: center; font-size: 9px; color: #444; flex-shrink: 0; }
        
        /* Bottone Espandi */
        .btn-expand { 
            background: none; border: none; color: #007bff; font-size: 10px; 
            cursor: pointer; font-weight: bold; margin-top: 5px; padding: 2px;
        }

        .stat-item { font-size: 13px; font-weight: bold; margin: 8px 0; color: #444; }
        select { width: 100%; margin-top: 5px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fdfdfd; }
        .flag-icon { width: 18px; border-radius: 2px; vertical-align: middle; margin-right: 4px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div id="count-box" class="stat-item">Calcolo...</div>
    <hr>
    <label class="stat-item">Nazione:</label>
    <select id="filter-nazione"><option value="Tutti">Tutte</option></select>
    
    <label class="stat-item">Sport:</label>
    <select id="filter-sport">
        <option value="Tutti">Tutti</option>
        <option value="Calcio">Calcio ‚öΩ</option>
        <option value="Pallacanestro">Pallacanestro üèÄ</option>
        <option value="Pallavolo">Pallavolo üèê</option>
        <option value="Rugby">Rugby üèâ</option>
        <option value="Pallamano">Pallamano ü§æ</option>
        <option value="Pallanuoto">Pallanuoto ü§Ω</option>
        <option value="Hockey su ghiaccio">Hockey su ghiaccio üèí</option>
        <option value="Football americano">Football americano üèà</option>
        <option value="Baseball">Baseball ‚öæ</option>
    </select>
    </div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const urlFoglio = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSB3hRuuuzUhGho2Wr_c0KBa8BYYMyASu6n0DrQ8q_o3GU3aw4_oC2vEvhuVbtmqR3Z3y0C5Zgh8Dji/pub?output=csv'; 

    var map = L.map('map', { zoomControl: false }).setView([45, 10], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);
    
    var oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true, nearbyDistance: 30 });
    var allMarkers = [];

    Papa.parse(urlFoglio, {
        download: true, header: true,
        complete: function(results) {
            const data = results.data;
            
            // Popolamento filtri... (omesso per brevit√†, resta uguale a prima)
            const nazioni = [...new Set(data.map(s => s.nazione))].filter(n => n).sort();
            nazioni.forEach(n => {
                let opt = document.createElement('option');
                opt.value = opt.innerText = n;
                document.getElementById('filter-nazione').appendChild(opt);
            });

            data.forEach(s => {
                if(!s.lat || !s.lng) return;

                let coloriArray = s.colori ? s.colori.split(',') : ['#333'];
                let borderStyle = coloriArray.length > 1 ? `linear-gradient(45deg, ${coloriArray.join(',')})` : coloriArray[0];
                let classeScomparso = s.stato === "scomparso" ? "club-scomparso" : "";

                var customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="logo-container ${classeScomparso}" style="background: ${borderStyle}; width:44px; height:44px;">
                             <img src="${s.logoAttuale}" class="logo-img-inner">
                           </div>`,
                    iconSize: [44, 44], iconAnchor: [22, 22]
                });

                var marker = L.marker([parseFloat(s.lat), parseFloat(s.lng)], { icon: customIcon });
                marker.dati = s;
                
                let flagHtml = s.codiceNazione ? `<img src="https://flagcdn.com/w40/${s.codiceNazione.toLowerCase()}.png" class="flag-icon">` : '';

                // HTML Centenario
                let centenarioHtml = s.logoCentenario ? `
                    <div class="centenario-box">
                        <span class="section-label">Logo Centenario</span>
                        <img src="${s.logoCentenario}" class="item-img">
                    </div>` : '';

                // Loghi Storici (scansione fino a 6 colonne)
                let itemsStorici = "";
                let count = 0;
                for(let i=1; i<=6; i++) {
                    let url = s[`logo_storia_${i}_url`];
                    let date = s[`logo_storia_${i}_date`];
                    if(url && url.trim() !== "") {
                        itemsStorici += `
                        <div class="storico-item">
                            <img src="${url}" class="item-img">
                            <b>${date || ''}</b>
                        </div>`;
                        count++;
                    }
                }

                let btnExpand = count > 3 ? `<button class="btn-expand" onclick="this.previousElementSibling.classList.toggle('collapsed'); this.innerText = this.innerText === 'Mostra altri' ? 'Mostra meno' : 'Mostra altri'">Mostra altri</button>` : '';
                
                let sezioneStorica = itemsStorici !== "" ? `
                    <div class="storico-section">
                        <span class="section-label">Loghi Storici</span>
                        <div class="storico-grid ${count > 3 ? 'collapsed' : ''}">
                            ${itemsStorici}
                        </div>
                        ${btnExpand}
                    </div>` : '';

                marker.descrizione = `
                    <div class="popup-card">
                        <div class="popup-header"><h2 class="popup-title">${s.nome}</h2></div>
                        <div class="popup-info">
                            ${flagHtml} <b>${s.nazione}</b><br>
                            Fondazione: <b>${s.fondazione}</b> | Sport: <b>${s.sport}</b>
                            ${s.stato === 'scomparso' ? '<p style="color:#d32f2f; font-weight:bold; margin:3px 0; font-size:10px;">CLUB NON PI√ô ATTIVO</p>' : ''}
                        </div>
                        ${centenarioHtml}
                        ${sezioneStorica}
                    </div>`;

                marker.addTo(map);
                oms.addMarker(marker);
                allMarkers.push(marker);
            });

            // Funzione filtri... (resta uguale)
            window.applicaFiltri = function() {
                const naz = document.getElementById('filter-nazione').value;
                const spor = document.getElementById('filter-sport').value;
                const stat = document.getElementById('filter-stato').value;
                const epoc = document.getElementById('filter-epoca').value;
                let vis = 0;
                allMarkers.forEach(m => {
                    let ok = true;
                    if (naz !== "Tutti" && m.dati.nazione !== naz) ok = false;
                    if (spor !== "Tutti" && m.dati.sport !== spor) ok = false;
                    if (stat !== "Tutti" && m.dati.stato !== stat) ok = false;
                    if (epoc === "Antiche" && parseInt(m.dati.fondazione) >= 1900) ok = false;
                    if (epoc === "Novecento" && (parseInt(m.dati.fondazione) < 1900 || parseInt(m.dati.fondazione) >= 2000)) ok = false;
                    if (epoc === "Duemila" && parseInt(m.dati.fondazione) < 2000) ok = false;
                    if (ok) { map.addLayer(m); vis++; } else { map.removeLayer(m); }
                });
                document.getElementById('count-box').innerHTML = `Squadre: <b>${vis}</b>`;
            }
            document.querySelectorAll('select').forEach(sel => sel.onchange = applicaFiltri);
            applicaFiltri();
        }
    });

    var popup = L.popup({ className: 'custom-popup' });
    oms.addListener('click', m => {
        popup.setContent(m.descrizione).setLatLng(m.getLatLng()).openOn(map);
    });
</script>
</body>
</html>
