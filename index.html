<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Mondiale Club - Progetto Avanzato</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #aad3df; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #eee; z-index: 9999; display: block; }
        #loader-progress { width: 0%; height: 100%; background: #007bff; transition: width 0.3s; }

        #ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 18px; border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 260px;
            max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.3s ease;
        }
        #ui-panel.collapsed { transform: translateX(-310px); }

        #toggle-panel-btn {
            position: absolute; top: 15px; left: 15px; z-index: 1001;
            background: white; border: none; border-radius: 8px; width: 40px; height: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; display: none;
            justify-content: center; align-items: center; font-size: 20px;
        }
        .close-panel { float: right; cursor: pointer; font-size: 20px; color: #999; }

        #search-container { margin-bottom: 15px; display: flex; gap: 5px; }
        #search-input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; font-size: 14px; font-family: inherit; }
        
        .btn-ui { background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; padding: 8px; cursor: pointer; font-size: 12px; font-weight: bold; font-family: inherit; }
        .btn-reset { background: #fee; color: #c33; border-color: #fcc; }

        .custom-div-icon { background: none; border: none; }
        
        .logo-container {
            border-radius: 50%; padding: 3px; display: flex; justify-content: center; align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 0 2px white, 0 3px 8px rgba(0,0,0,0.4); 
            width: 44px; height: 44px; position: relative;
        }

        .highlight-active {
            animation: pulse-gold 2s infinite;
            box-shadow: 0 0 0 4px #ffd700, 0 0 15px #ffd700 !important;
        }
        @keyframes pulse-gold {
            0% { transform: scale(1); box-shadow: 0 0 0 0px rgba(255, 215, 0, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0px rgba(255, 215, 0, 0); }
        }

        .logo-container:hover { transform: scale(1.4); z-index: 9999 !important; }
        .logo-container:active { transform: scale(0.9); }
        
        .logo-img-inner { width: 100%; height: 100%; border-radius: 50%; background: white; object-fit: contain; }
        
        .gender-badge {
            position: absolute; top: -2px; right: -2px;
            width: 16px; height: 16px; background: #ff69b4;
            color: white; border-radius: 50%; border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .club-scomparso { filter: grayscale(100%); }
        .logo-container:hover.club-scomparso { filter: grayscale(0%); }

        .cluster-modern {
            background: #007bff; border: 2px solid #ffffff;
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            color: #ffffff; font-weight: bold; font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .custom-popup .leaflet-popup-content-wrapper { 
            border-radius: 12px; padding: 5px; 
            border: 4px solid transparent;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        
        .popup-card { text-align: center; font-family: 'Segoe UI', sans-serif; width: 220px; }
        .popup-header { border-bottom: 2px solid #eee; margin-bottom: 10px; padding-bottom: 8px; }
        .popup-title { margin: 5px 0; color: #222; font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px; }
        .popup-info { font-size: 13px; color: #555; line-height: 1.4; }

        .btn-update {
            display: block; margin-top: 10px; font-size: 10px; color: #999; 
            text-decoration: none; border-top: 1px dotted #ccc; padding-top: 5px;
        }
        .btn-update:hover { color: #555; text-decoration: underline; }

        .precedenti-box { background: #f5f5f5; border: 1px solid #ddd; margin-top: 8px; padding: 8px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }
        .precedenti-grid { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .origin-wrapper { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .origin-logo { 
            width: 35px; height: 35px; object-fit: contain; border-radius: 50%; 
            background: white; border: 1px solid #bbb; padding: 2px;
            transition: transform 0.2s;
        }
        .origin-logo:hover { transform: scale(1.2); border-color: #007bff; }
        .origin-name { font-size: 9px; margin-top: 3px; color: #555; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .btn-link-club {
            display: block; background: #fff; border: 1px solid #ccc; color: #555; 
            font-size: 10px; padding: 4px; border-radius: 4px; cursor: pointer;
        }

        /* Tabelle Loghi Uniformate */
        .anniversario-box, .storici-container { margin: 10px 0; padding: 8px; border-radius: 8px; }
        
        /* Colori specifici */
        .anniversario-box { background: #fff9c4; border: 1px solid #fbc02d; } /* ORO */
        .storici-container { background: #e3f2fd; border: 1px solid #90caf9; } /* AZZURRINO */

        .box-label { font-size: 9px; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; color: #555; }
        .anniversario-img, .storico-img { width: 45px; height: 45px; object-fit: contain; background: white; border: 1px solid #eee; border-radius: 4px; }
        .storico-grid, .anniversario-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .storico-item, .anniversario-item { flex: 0 0 45px; text-align: center; font-size: 9px; color: #444; }
        
        .btn-espandi { background: none; border: none; color: #007bff; font-size: 10px; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; width: 100%; font-weight: bold; }
        .hidden-logos { display: none; }

        .stat-item { font-size: 13px; font-weight: bold; margin: 8px 0; color: #444; }
        #stats-breakdown { font-size: 11px; color: #666; font-weight: normal; margin-top: 5px; line-height: 1.2; }

        select { width: 100%; margin-top: 5px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        .flag-icon { width: 22px; border-radius: 3px; vertical-align: middle; margin-right: 6px; border: 1px solid #eee; }

        .locate-btn {
            background: white; width: 34px; height: 34px; display: flex;
            justify-content: center; align-items: center; border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4); cursor: pointer; margin-bottom: 10px;
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(20px); }

        #timeline-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255,255,255,0.9); padding: 10px 20px;
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 15px; width: 80%; max-width: 600px;
        }
        #timeline-slider { flex-grow: 1; cursor: pointer; }
        #year-display { font-weight: bold; color: #007bff; min-width: 80px; text-align: center; }

        .notification-toast {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: #333; color: white; padding: 12px 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; animation: slideIn 0.5s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .btn-wiki {
            display: inline-block; margin: 8px 0; padding: 6px 14px;
            background: #ffffff; color: #3366cc; text-decoration: none;
            border: 2px solid #3366cc; border-radius: 20px; font-size: 11px; 
            font-weight: bold; transition: all 0.2s;
        }
        .btn-wiki:hover { background: #3366cc; color: #ffffff; }
    </style>
</head>
<body>

<div id="loader"><div id="loader-progress"></div></div>
<div id="notification" class="notification-toast"></div>

<div id="timeline-container">
    <span style="font-size: 12px; font-weight: bold;">TIMELINE</span>
    <input type="range" id="timeline-slider" min="1850" max="2026" value="2026">
    <div id="year-display">Fino al 2026</div>
</div>

<button id="toggle-panel-btn" onclick="togglePanel()">‚ò∞</button>

<div id="ui-panel">
    <span class="close-panel" onclick="togglePanel()">√ó</span>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Cerca squadra o stadio... (premi /)">
        <button class="btn-ui btn-reset" onclick="resetFiltri()">‚úï</button>
    </div>
    
    <button class="btn-ui" style="width:100%; margin-bottom:10px;" onclick="clubCasuale()">üé≤ Club Casuale</button>
    <div id="count-box" class="stat-item">Caricamento...</div>
    <div id="stats-breakdown"></div> 
    
    <div class="stat-item" style="background: #f0f7ff; padding: 8px; border-radius: 8px; border: 1px solid #cce5ff; margin-top:10px;">
        Raggruppa loghi: 
        <label class="switch">
            <input type="checkbox" id="cluster-toggle" checked onchange="applicaFiltri()">
            <span class="slider"></span>
        </label>
    </div>

    <hr>
    
    <label class="stat-item">Nazione:</label>
    <select id="filter-nazione"><option value="Tutti">Tutte le nazioni</option></select>
    
    <label class="stat-item">Sport:</label>
    <select id="filter-sport">
        <option value="Tutti">Tutti</option>
        <option value="Calcio">Calcio ‚öΩ</option>
        <option value="Pallacanestro">Pallacanestro üèÄ</option>
        <option value="Pallavolo">Pallavolo üèê</option>
        <option value="Rugby">Rugby üèâ</option>
        <option value="Pallamano">Pallamano ü§æ</option>
        <option value="Pallanuoto">Pallanuoto ü§Ω</option>
        <option value="Hockey su ghiaccio">Hockey su ghiaccio üèí</option>
        <option value="Football americano">Football americano üèà</option>
        <option value="Baseball">Baseball ‚öæ</option>
    </select>
    
    <label class="stat-item">Genere:</label>
    <select id="filter-genere">
        <option value="Tutti">Tutti</option>
        <option value="m">Maschile</option>
        <option value="f">Femminile</option>
    </select>

    <label class="stat-item">Stato Club:</label>
    <select id="filter-stato">
        <option value="Tutti">Tutti</option>
        <option value="attivo">Solo Attivi</option>
        <option value="scomparso">Solo Scomparsi</option>
    </select>
    
    <label class="stat-item">Epoca:</label>
    <select id="filter-epoca">
        <option value="Tutti">Tutte</option>
        <option value="Antiche">Prima del 1900</option>
        <option value="PrimoNovecento">1900 - 1949</option>
        <option value="SecondoNovecento">1950 - 1999</option>
        <option value="Duemila">Dal 2000 in poi</option>
    </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

<script>
    const urlFoglio = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSB3hRuuuzUhGho2Wr_c0KBa8BYYMyASu6n0DrQ8q_o3GU3aw4_oC2vEvhuVbtmqR3Z3y0C5Zgh8Dji/pub?output=csv'; 
    const linkCrowdsourcingBase = "https://docs.google.com/forms/d/e/1FAIpQLScnl0Qz7286ghO6Rkb2UxugFHGaCU_gGVAljUdkbp95zqhr2g/viewform?usp=pp_url&entry.1326851473=";

    const sportIcons = { "Calcio": "‚öΩ", "Pallacanestro": "üèÄ", "Pallavolo": "üèê", "Rugby": "üèâ", "Pallamano": "ü§æ", "Pallanuoto": "ü§Ω", "Hockey su ghiaccio": "üèí", "Football americano": "üèà", "Baseball": "‚öæ" };
    const placeholderLogo = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTIgMmwtMTAgOWgxNHoiPjwvcGF0aD48Y2lyY2xlIGN4PSIxMiIgY3k9IjEzIiByPSI5Ij48L2NpcmNsZT48L3N2Zz4=";

    var osm = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });
    var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' });
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });
    var heatLayer = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 10 });

    var hash = window.location.hash.substring(1).split('/');
    var startCenter = hash.length === 3 ? [hash[1], hash[2]] : [45, 10];
    var startZoom = hash.length === 3 ? hash[0] : 5;

    var map = L.map('map', { layers: [osm], zoomControl: false, dragging: !L.Browser.mobile, tap: !L.Browser.mobile }).setView(startCenter, startZoom);
    
    const oraAttuale = new Date().getHours();
    if (oraAttuale >= 20 || oraAttuale < 7) {
        map.removeLayer(osm);
        map.addLayer(dark);
    }

    map.on('moveend', function() {
        var center = map.getCenter();
        window.history.replaceState(null, null, `#${map.getZoom()}/${center.lat.toFixed(4)}/${center.lng.toFixed(4)}`);
        localStorage.setItem('lastPos', JSON.stringify({lat: center.lat, lng: center.lng, zoom: map.getZoom()}));
    });

    var baseMaps = { "Standard": osm, "Dark Mode üåô": dark, "Satellite üõ∞Ô∏è": satellite };
    var overlayMaps = { "Heatmap üî•": heatLayer };
    L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var markersLayer = L.featureGroup();
    var markers = L.markerClusterGroup({ 
        disableClusteringAtZoom: 17, 
        showCoverageOnHover: false,
        iconCreateFunction: function(cluster) {
            return L.divIcon({ html: `<div class="cluster-modern">${cluster.getChildCount()}</div>`, className: 'custom-cluster-icon', iconSize: L.point(40, 40) });
        }
    });

    var oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true, nearbyDistance: 30 });
    var allMarkers = [];
    var visibiliAttualmente = [];
    var popup = L.popup({ className: 'custom-popup' });

    const normalizeText = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";

    function togglePanel() {
        const panel = document.getElementById('ui-panel');
        const btn = document.getElementById('toggle-panel-btn');
        panel.classList.toggle('collapsed');
        btn.style.display = panel.classList.contains('collapsed') ? 'flex' : 'none';
    }

    if (window.innerWidth < 768) {
        setTimeout(togglePanel, 500);
    }

    function showNotification(msg) {
        const box = document.getElementById('notification');
        box.innerText = msg;
        box.style.display = 'block';
        setTimeout(() => { box.style.display = 'none'; }, 5000);
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === '/' && document.activeElement !== document.getElementById('search-input')) {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
    });

    map.on('popupopen', function(e) {
        var marker = e.popup._source;
        if (marker && marker.dati) {
            let coloriArray = marker.dati.colori ? marker.dati.colori.split(',') : ['#333'];
            let wrapper = e.popup.getElement().querySelector('.leaflet-popup-content-wrapper');
            wrapper.style.border = `4px solid ${coloriArray[0]}`;
        }
    });

    window.vaiAClub = function(nomeClub) {
        map.closePopup();
        const target = allMarkers.find(m => m.dati.nome.trim() === nomeClub.trim());
        if(target) {
            map.flyTo(target.getLatLng(), 16);
            map.once('moveend', function() {
                setTimeout(() => {
                    popup.setContent(target.descrizione).setLatLng(target.getLatLng()).openOn(map);
                }, 100);
            });
        }
    };

    function resetFiltri() {
        document.getElementById('search-input').value = '';
        document.getElementById('timeline-slider').value = 2026;
        document.getElementById('year-display').innerText = "Fino al 2026";
        document.querySelectorAll('select').forEach(s => s.value = 'Tutti');
        applicaFiltri();
    }

    function clubCasuale() {
        map.closePopup();
        if (visibiliAttualmente.length === 0) return;
        const randomMarker = visibiliAttualmente[Math.floor(Math.random() * visibiliAttualmente.length)];
        map.flyTo(randomMarker.getLatLng(), 16); 
        map.once('moveend', () => { 
            popup.setContent(randomMarker.descrizione).setLatLng(randomMarker.getLatLng()).openOn(map); 
        });
    }

    window.toggleLoghi = function(btn) {
        const container = btn.previousElementSibling;
        const isHidden = container.style.display !== "flex";
        container.style.display = isHidden ? "flex" : "none";
        btn.innerText = isHidden ? "comprimi ‚ñ≤" : "mostra altri ‚ñº";
    };

    Papa.parse(urlFoglio, {
        download: true, header: true,
        complete: function(results) {
            document.getElementById('loader').style.display = 'none';
            const data = results.data;
            
            const nazioni = [...new Set(data.map(s => s.nazione))].filter(n => n).sort();
            nazioni.forEach(n => {
                let opt = document.createElement('option'); opt.value = opt.innerText = n;
                document.getElementById('filter-nazione').appendChild(opt);
            });

            const savedFilters = JSON.parse(localStorage.getItem('mapFilters') || '{}');
            Object.keys(savedFilters).forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = savedFilters[id];
            });

            data.forEach((s, index) => {
                if(!s.lat || !s.lng) return;
                document.getElementById('loader-progress').style.width = (index / data.length * 100) + '%';

                let coloriArray = s.colori ? s.colori.split(',') : ['#333'];
                let borderStyle = coloriArray.length > 1 ? `linear-gradient(45deg, ${coloriArray.join(',')})` : coloriArray[0];
                let classeScomparso = s.stato === "scomparso" ? "club-scomparso" : "";
                let badgeFemminile = (s.genere && s.genere.toLowerCase() === 'f') ? '<div class="gender-badge">‚ôÄ</div>' : '';
                let highlightClass = (s.highlight && s.highlight.toUpperCase() === 'SI') ? 'highlight-active' : '';

                var marker = L.marker([parseFloat(s.lat), parseFloat(s.lng)], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="logo-container ${classeScomparso} ${highlightClass}" style="background: ${borderStyle};">
                                     ${badgeFemminile}
                                     <img src="${s.logo_attuale}" class="logo-img-inner" onerror="this.src='${placeholderLogo}';">
                                   </div>`,
                        iconSize: [44, 44], iconAnchor: [22, 22]
                    })
                });
                marker.dati = s;
                marker.nomeNormalizzato = normalizeText(s.nome);

                let flagHtml = s.codice_nazione ? `<img src="https://flagcdn.com/w40/${s.codice_nazione.toLowerCase()}.png" class="flag-icon">` : '';
                let emojiSport = sportIcons[s.sport] || "üèÜ"; 

                let precedentiHTML = '';
                [s.club_precedente_1, s.club_precedente_2, s.club_precedente_3].forEach(cp => {
                    if(cp && cp.trim() !== "") {
                        let clubTrovato = data.find(item => item.nome && item.nome.trim() === cp.trim());
                        let nomeEscaped = cp.replace(/'/g, "\\'");
                        if (clubTrovato && clubTrovato.logo_attuale) {
                            precedentiHTML += `
                                <div class="origin-wrapper" onclick="vaiAClub('${nomeEscaped}')" title="Vai a ${cp}">
                                    <img src="${clubTrovato.logo_attuale}" class="origin-logo" onerror="this.src='${placeholderLogo}';">
                                    <span class="origin-name">${cp}</span>
                                </div>`;
                        } else {
                            precedentiHTML += `<button class="btn-link-club" onclick="vaiAClub('${nomeEscaped}')">${cp}</button>`;
                        }
                    }
                });

                // --- LOGICA LOGHI STORICI (Azzurrino) ---
                let loghiItems = [];
                for(let i=1; i<=10; i++) {
                    let url = s[`logo_storia_${i}_url`];
                    if(url) loghiItems.push(`<div class="storico-item"><img src="${url}" class="storico-img" onerror="this.src='${placeholderLogo}';"><b>${s[`logo_storia_${i}_date`] || ''}</b></div>`);
                }

                // --- LOGICA LOGHI ANNIVERSARIO (Oro) ---
                let annivItems = [];
                for(let i=1; i<=5; i++) {
                    let url = s[`logo_anniversario_${i}_url`];
                    let dataA = s[`logo_anniversario_${i}_data`];
                    if(url) annivItems.push(`<div class="anniversario-item"><img src="${url}" class="anniversario-img" onerror="this.src='${placeholderLogo}';"><b>${dataA || ''}</b></div>`);
                }

                // --- LOGICA TASTO WIKIPEDIA ---
                let wikiBtn = "";
                    if (s.wiki && s.wiki.toLowerCase() === "si") {
                    const wikiNome = s.nome.replace(/\s+/g, '_');
                    wikiBtn = `<a href="https://en.wikipedia.org/wiki/${wikiNome}" target="_blank" class="btn-wiki">Wikipedia üìñ</a>`;
                }

                marker.descrizione = `
                    <div class="popup-card">
                        <div class="popup-header"><h2 class="popup-title">${emojiSport} ${s.nome}</h2></div>
                        <div class="popup-info">
                            ${flagHtml} <b>${s.nazione}</b><br>
                            Fondazione: <b>${s.fondazione}</b> ${s.scioglimento ? `| Sciolta: <b>${s.scioglimento}</b>` : ''}<br>
                            Sport: <b>${s.sport}</b> | Stadio: <b>${s.stadio_nome || 'N.D.'}</b>
                        </div>

                        ${wikiBtn} ${precedentiHTML !== '' ? `<div class="precedenti-box"><span class="box-label">Club d'Origine</span><div class="precedenti-grid">${precedentiHTML}</div></div>` : ''}
                        
                        ${annivItems.length > 0 ? `
                            <div class="anniversario-box">
                                <span class="box-label">Loghi Anniversario</span>
                                <div class="anniversario-grid">${annivItems.slice(0,3).join('')}</div>
                                ${annivItems.length > 3 ? `
                                    <div class="anniversario-grid hidden-logos" style="margin-top:8px;">${annivItems.slice(3).join('')}</div>
                                    <button class="btn-espandi" onclick="toggleLoghi(this)">mostra altri ‚ñº</button>
                                ` : ''}
                            </div>` : ''}

                        ${loghiItems.length > 0 ? `
                            <div class="storici-container">
                                <span class="box-label">Loghi Storici</span>
                                <div class="storico-grid">${loghiItems.slice(0,3).join('')}</div>
                                ${loghiItems.length > 3 ? `
                                    <div class="storico-grid hidden-logos" style="margin-top:8px;">${loghiItems.slice(3).join('')}</div>
                                    <button class="btn-espandi" onclick="toggleLoghi(this)">mostra altri ‚ñº</button>
                                ` : ''}
                            </div>` : ''}
                        
                        <a href="${linkCrowdsourcingBase}${encodeURIComponent(s.nome)}" target="_blank" class="btn-update">Segnala aggiornamento/errore ‚úèÔ∏è</a>
                    </div>`;

                oms.addMarker(marker);
                allMarkers.push(marker);
            });

            window.applicaFiltri = function() {
                const sVal = normalizeText(document.getElementById('search-input').value);
                const nVal = document.getElementById('filter-nazione').value;
                const stVal = document.getElementById('filter-stato').value;
                const spVal = document.getElementById('filter-sport').value;
                const eVal = document.getElementById('filter-epoca').value;
                const gVal = document.getElementById('filter-genere').value;
                const tVal = parseInt(document.getElementById('timeline-slider').value);
                const isClusterEnabled = document.getElementById('cluster-toggle').checked;
                
                localStorage.setItem('mapFilters', JSON.stringify({
                    'filter-nazione': nVal, 'filter-stato': stVal, 'filter-sport': spVal,
                    'filter-epoca': eVal, 'filter-genere': gVal, 'timeline-slider': tVal
                }));

                document.getElementById('year-display').innerText = tVal === 2026 ? "Tutti i tempi" : "Fino al " + tVal;

                markers.clearLayers();
                markersLayer.clearLayers();
                let heatPoints = [];
                let sportCounts = {};
                
                visibiliAttualmente = allMarkers.filter(m => {
                    let ok = true;
                    const stadioNorm = normalizeText(m.dati.stadio_nome);
                    const anno = parseInt(m.dati.fondazione);

                    if (sVal && !m.nomeNormalizzato.includes(sVal) && !stadioNorm.includes(sVal)) ok = false;
                    if (nVal !== "Tutti" && m.dati.nazione !== nVal) ok = false;
                    if (stVal !== "Tutti" && m.dati.stato !== stVal) ok = false;
                    if (spVal !== "Tutti" && m.dati.sport !== spVal) ok = false;
                    if (gVal === "f" && (!m.dati.genere || m.dati.genere.toLowerCase() !== 'f')) ok = false;
                    if (gVal === "m" && m.dati.genere && m.dati.genere.toLowerCase() === 'f') ok = false;
                    if (anno > tVal) ok = false;

                    if (eVal === "Antiche" && anno >= 1900) ok = false;
                    if (eVal === "PrimoNovecento" && (anno < 1900 || anno >= 1950)) ok = false;
                    if (eVal === "SecondoNovecento" && (anno < 1950 || anno >= 2000)) ok = false;
                    if (eVal === "Duemila" && anno < 2000) ok = false;
                    
                    if(ok) {
                        heatPoints.push([m.getLatLng().lat, m.getLatLng().lng, 0.5]);
                        sportCounts[m.dati.sport] = (sportCounts[m.dati.sport] || 0) + 1;
                    }
                    return ok;
                });

                if (isClusterEnabled) {
                    map.removeLayer(markersLayer);
                    visibiliAttualmente.forEach(m => markers.addLayer(m));
                    map.addLayer(markers);
                } else {
                    map.removeLayer(markers);
                    visibiliAttualmente.forEach(m => markersLayer.addLayer(m));
                    map.addLayer(markersLayer);
                }

                heatLayer.setLatLngs(heatPoints);
                document.getElementById('count-box').innerHTML = `Squadre filtrate: <b>${visibiliAttualmente.length}</b>`;
                
                let statsText = Object.entries(sportCounts)
                    .sort((a,b) => b[1] - a[1])
                    .map(([name, count]) => `${sportIcons[name] || ''} ${count}`).join(' ‚Ä¢ ');
                document.getElementById('stats-breakdown').innerHTML = statsText;
                
                if (nVal !== "Tutti" && visibiliAttualmente.length > 0 && sVal === "") {
                    const group = new L.featureGroup(visibiliAttualmente);
                    map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 7 });
                }
            }

            document.getElementById('search-input').oninput = applicaFiltri;
            document.getElementById('timeline-slider').oninput = applicaFiltri; 
            document.querySelectorAll('select').forEach(sel => sel.onchange = applicaFiltri);
            applicaFiltri();
        }
    });

    var LocateControl = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var div = L.DomUtil.create('div', 'locate-btn');
            div.innerHTML = '<svg viewBox="0 0 24 24" width="20"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>';
            div.onclick = function(e){ 
                e.stopPropagation(); 
                map.locate({setView: true, maxZoom: 13}); 
            };
            return div;
        }
    });
    map.addControl(new LocateControl());

    map.on('locationfound', function(e) {
        let nearby = null;
        let minDist = 500; 

        allMarkers.forEach(m => {
            let dist = e.latlng.distanceTo(m.getLatLng());
            if (dist < minDist) {
                nearby = m.dati.nome;
                minDist = dist;
            }
        });

        if (nearby) {
            showNotification(`üìç Sei vicino allo stadio del ${nearby}!`);
        } else {
            showNotification("üìç Posizione trovata!");
        }
    });

    function onMarkerClick(a) {
        map.panTo(a.layer.getLatLng()); 
        popup.setContent(a.layer.descrizione).setLatLng(a.layer.getLatLng()).openOn(map);
    }

    markers.on('click', onMarkerClick);
    markersLayer.on('click', onMarkerClick);
</script>
</body>
</html>
