<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Sportiva Mondiale</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        /* Il box delle statistiche e filtri */
        #ui-panel {
            position: absolute; bottom: 20px; left: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3); border: 2px solid #333;
        }
        .logo-marker { border-radius: 50%; background: white; border: 2px solid #333; }
        .storico-img { width: 45px; height: 45px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        select { padding: 5px; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

<div id="ui-panel">
    <strong>STATISTICHE</strong>
    <div id="count-box">Caricamento...</div>
    <hr>
    <strong>FILTRA PER PAESE</strong>
    <select id="filter-nazione">
        <option value="Tutti">Mostra Tutti</option>
        <option value="Italia">Italia</option>
        <option value="Inghilterra">Inghilterra</option>
    </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>

<script>
    // 1. Setup Mappa
    var map = L.map('map').setView([45, 10], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. Setup Spiderfier (Per Inter/Milan che condividono lo stadio)
    var oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true, nearbyDistance: 25 });
    var popup = L.popup();

    // 3. Carichiamo i dati dal file JSON
    fetch('squadre.json')
        .then(res => res.json())
        .then(squadre => {
            let markers = [];

            squadre.forEach(s => {
                // Icona personalizzata con il logo attuale
                var icona = L.icon({ iconUrl: s.logoAttuale, iconSize: [40, 40], className: 'logo-marker' });
                
                // Creiamo il marker
                var marker = L.marker(s.coords, { icon: icona });
                
                // Salviamo i dati della nazione nel marker per poterlo filtrare
                marker.nazione = s.nazione;

                // Contenuto del fumetto (Popup)
                let storiciHtml = s.loghiStorici.map(l => `
                    <div style="display:inline-block; text-align:center;">
                        <img src="${l.url}" class="storico-img"><br><small>${l.inizio}-${l.fine}</small>
                    </div>
                `).join('');

                marker.descrizione = `
                    <div style="text-align:center">
                        <h2>${s.nome}</h2>
                        <p>Fondato nel: <b>${s.fondazione}</b></p>
                        <div style="background:#eee; padding:5px; border-radius:5px;">
                            <b>Loghi Storici:</b><br>${storiciHtml || 'Nessuno inserito'}
                        </div>
                    </div>`;

                // Aggiungiamo alla mappa e allo spiderfier
                marker.addTo(map);
                oms.addMarker(marker);
                markers.push(marker);
            });

            // Gestione click (Spiderfier richiede questo modo per aprire i popup)
            oms.addListener('click', function(marker) {
                popup.setContent(marker.descrizione);
                popup.setLatLng(marker.getLatLng());
                map.openPopup(popup);
            });

            // Funzione Filtro Nazione
            document.getElementById('filter-nazione').addEventListener('change', function(e) {
                let nazione = e.target.value;
                let count = 0;
                markers.forEach(m => {
                    if (nazione === "Tutti" || m.nazione === nazione) {
                        map.addLayer(m);
                        count++;
                    } else {
                        map.removeLayer(m);
                    }
                });
                document.getElementById('count-box').innerHTML = `Squadre visibili: <b>${count}</b>`;
            });

            // Conteggio iniziale
            document.getElementById('count-box').innerHTML = `Squadre visibili: <b>${squadre.length}</b>`;
        });
</script>
</body>
</html>